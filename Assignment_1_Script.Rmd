---
title: "Killifish Respirometry"
author: "Hayden Simm"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# loading packages --------------------------------------------------------

library(tidyverse)
library(ggplot2)
library(respR)
```

```{r}
# loading respirometry dataframe -------------------------------------------------------

df_fish<-read.delim("2025-01-20_181758_KILLIFISH_RESPIROMETRY1_JAN2.txt")
```

#remove the first rows which include device information
```{r}
df_fish<-df_fish[-c(0:141),] 
```

#removing excess columns which we are not analyzing
```{r}
df_fish <- df_fish[,c(3,4,22,40,58,81,99,117,135)]
```

#renaming columns to the instrument channel names
```{r}
df_fish <- df_fish %>%
  rename (time = 1,  A1 = 2,  A2 = 3,   A3 = 4,   A4 = 5,
          B1 = 6,    B2 = 7,  B3 = 8, B4 = 9)
```

#making values numeric for RespR because they are currently character
```{r}
df_fish[,c(1:9)] <- sapply(df_fish[,c(1:9)], as.numeric) #this will introduce NAs
df_fish[,c(1:9)] <- sapply(df_fish[,c(1:9)], unlist)

#remove rows at end that contain no data
df_fish <- df_fish %>% drop_na()
```

#MMR
```{r}
MMR_A1<-df_fish %>%
  select(time, A1) %>%
  na.omit() %>%
  subset_data(from = 200, to = 400, by = "row") %>% #subset to time when MMR was preformed
  inspect(time = 1, oxygen = 2) %>%
  auto_rate(method = "linear", width = 0.2, by = "row") %>%
  convert_rate(oxy.unit = '%Air', time.unit = 's', output.unit = 'umol/min/g', 
               volume = 0.175, S = 28, t = 10, mass = 0.00689) %>%
  ## ^adjust volume (in litres), salinity (ppt), temperature (C), mass (in kg)
  select_rate(method = "rsq", n = c(0.9,1)) %>%
  select_rate(method = "rank") %>%
  select_rate(method = "highest", n = 1) %>%
  summary(export = TRUE) 
```

#SMR
```{r}
SMR_A1<-df_fish %>%
  select(time, A1) %>%
  na.omit() %>%
  inspect(time = 1, oxygen = 2, plot = F) %>%
  subset_data(from = 30000, to = 40000, by = "time") %>% #subset to after MMR and middle of night 
  auto_rate.int(start = 600, #time that flush pump is on, in seconds
                wait = 50, 
                measure = 250, #wait + measure times should add to time that flush pump is off
                method = "linear", width = 100, by = "time") %>%
  convert_rate(oxy.unit = '%Air', time.unit = 's', output.unit = 'umol/min/g', 
               volume = 0.175, S = 28, t = 10, mass = 0.00689) %>%
  #plot(pos =10) %>%
  #summary(pos =10) %>%
  select_rate(method = "rsq", n = c(0.9,1)) %>%
  select_rate(method = "lowest_percentile", n = 0.1) %>%
  mean() %>% #this is your final value
  summary(export = TRUE)

```


